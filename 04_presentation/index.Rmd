---
title: 'A Forecasting Study on Swedish Wine Sales `r fontawesome::fa("wine-bottle", fill = "#b50000")`'
subtitle: "     Term Paper Statistical Learning"
author: "     Jonathan Berrisch & Timo Rammert"
date: "     23.09.2019"
output:
  xaringan::moon_reader:
    css: ["default", "assets/sydney-fonts.css", "assets/sydney.css"]
    self_contained: false # if true, fonts will be stored locally
    seal: true # show a title slide with YAML information
    includes:
      in_header: "assets/mathjax-equation-numbers.html"
    nature: 
      beforeInit: ["assets/remark-zoom.js", "https://platform.twitter.com/widgets.js"]
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
      ratio: '16:9'
      navigation:
        scroll: false # disable slide transitions by scrolling
---
background-image: url("assets/ml_plot.png")
background-position: 100% 50%
background-size: 50% 75%

# Agenda

.pull-left[
.font130[
.content-box-blue[
1. Introduction
2. Data and Variables
3. Validation Approach
4. Analysis
5. Robustness
6. Final Model
7. Discussion
]
]
]


---

```{r, load_refs, echo=FALSE, cache=FALSE}
library(RefManageR)
BibOptions(check.entries = FALSE, 
           bib.style = "authoryear", 
           cite.style = 'authoryear', 
           style = "markdown",
           hyperlink = FALSE, 
           dashed = FALSE)
myBib <- ReadBib("assets/example.bib", check = FALSE)
```

class: segue, center, middle

# Introduction

```{r echo=FALSE, include=FALSE}
library(dplyr)
library(plotly)
library(fontawesome)
library(rpart)
library(stargazer)
library(ggplot2)
# remotes::install_github("berrij/fontawesome")
```

---

# Introduction

</br>

.pull-left[

.content-box-blue[

Goal:
  - Forecasting Swedish wine sales in litres
  - Identification of determinants of wine sales

Basis:
  - Dataset by Friberg and Grönqvist (2012)
  - Methods and procedures based on ‘An Introduction to Statistical Learning with Applications in R’
]]


.pull-right[

.content-box-grey[

Predictions based on existing Literature:

- Expert opinion increases sales - depending on received reviews (Hilger et al. (2011), Ashenfelter and Jones (2013))
- Regional influences for local wine sales (Bicknell and MacDonald (2012))

]]

</br>

???

Dataset previously analyzed in Article in American Economic Journal

---
class: inverse, center, middle 

# Data and Variables

---

# Data and Variables

</br>

.pull-left[

.content-box-green[

Data set train:
  - Sales from 2002-01-02 until 2006-02-22
  - 145179 observations of 58 variables (before preprocessing)
  - 41416 observations of 45 variables (after preprocessing)
]]

.pull-right[

.content-box-red[


Data set test:
  - Sales from 2006-02-22 until 2007-01-10
  - 48395 observations of 58 variables (before preprocessing)
  - 9783 observations of 45 variables (after preprocessing)
]]

</br>

```{r tables-VarType, echo = F}
load("../00_data/output_paper/01_typeof_vec.rda")
knitr::kable(t(typeof_vec), caption = "Frequency of Variable Types.", format = "html")
```

???

- Densities of variable litre is nearly the same for train (from 0 to 184200) and test (from 0 to 184398)
- Variables: name of wine, country, price, amount sold per week,market share, segments, reviews-related variables, etc.
- No great differences in prices (only in terms of max in train): 
  - price in train: from 38 to 1149 with mean 108 and median 79
  - price in test: from 43 to 349 with mean 108 and median 87
- Difference in segments: test only includes red, sparkling and white

---
class: inverse, center, middle

# Validation Approach

# `r fontawesome::fa("search", fill = "white")` 

---

# Validation Approach

.pull-left[

.content-box-blue[

### Theoretical

- Crossvalidation using 5 folds


- RMSE $$\sqrt{\frac{1}{n}\sum_{i = 1}^{n}\left(y_i-\hat{y}_i\right)^2}$$ as key performance measure for evaluating models


- Further robustness checks for assesing validity of results obtained

]
]

.pull-right[

.content-box-blue[

### Technical

- Using Rstudio Jobs Feature
  - Multicore Processing
  - Model independent CV approach
  
```{}
library(rstudioapi)

for(i in 1:5){

  fold_data <- data_list[[i]]
  jobRunScript("path_to_model",
               workingDir = "../statl",
               importEnv = T)
               
}
```

]
]

???

- 5 Folds because trade-off between validation and computational effort


---

class: inverse, center, middle

# Analysis

# `r fontawesome::fa("terminal", fill = "white")` 
  
---
# Analysis

### Mean Regression and Linear Regression

<br>

Baseline methods for comparing the predictions made by further methods

<br>

.pull-left[

  .content-box-grey[

Mean Regression:
- Mean litres sold: 6886
- RMSE-Train: 13340


  ]

]

.pull-right[

  .content-box-grey[

Linear Regression:
- Factor variables transformed into dummy variables $\rightarrow$ 757 variables
- RMSE-Train: 5572


  ]
]

---

# Analysis

## Least Absolute Shrinkage and Selection Operator
<br>

.font130[
.content-box-blue[
- Method combining linear regression and shrinking of coefficient estimates
- Fits linear model constrained by penalty term, i.e., it minimizes $\sum_{i=1}^{n}(y_i - \beta_0 - \sum_{j=1}^{p}\beta_jx_{ij})^2+\lambda\sum_{j=1}^{p}|\beta_j|.$
- RMSE-Train: 5548
]
]

???

Also calculated Lasso for loglitres: RMSE of 5812

---

# Analysis

## Least Absolute Shrinkage and Selection Operator

<div style="position:relative; margin-top:-25px; z-index: 0">

```{r, echo=FALSE}

# load(file = "../04_presentation/data/lasso.plot.rda")
# 
# pm <- lasso.plot + theme_minimal()
# 
# lasso.plotly.plot <- plotly::ggplotly(pm) %>% config(displayModeBar = F)
# 
f <- paste0("p.lasso.html")
# htmlwidgets::saveWidget(lasso.plotly.plot, f)
htmltools::tags$iframe(
    src= f,
    width="100%",
    height="525px",
    scrolling="no",
    seamless="seamless",
    frameBorder="0"
  )

```

</div>

---

# Analysis

### Principal Components Regression and Partial Least Squares

<div style="position:relative; margin-top:-25px; z-index: 0">

```{r, echo=FALSE, message=FALSE}

# load(file = "../04_presentation/data/pca.rda")

# pca.plot <- plotly::ggplotly(pca) %>% config(displayModeBar = F)

f <- paste0("p.pca.html")
# htmlwidgets::saveWidget(pca.plot, f)
htmltools::tags$iframe(
    src=f,
    width="100%", 
    height="525px",
    scrolling="no", 
    seamless="seamless", 
    frameBorder="0"
  )

```

</div>

---

# Analysis

### Splines

---

# Analysis

### Decision Tree Methods

#### Single Regression Tree

---

# Analysis

### Decision Tree Methods

#### Bootstrap Aggregation

---

# Analysis

### Decision Tree Methods

#### Random Forest

---

# Analysis

### Decision Tree Methods

#### Random Forest

<div style="position:relative; margin-top:-200px; z-index: 0">

```{r, echo=FALSE, message=FALSE}
### Summary Random Forest  ####

# Get filenames
files <- dir(path = "../02_analysis/cv/rf")
df_rf_list <- list()

# Load the data
for(i in 1:(length(files))){
  load(file = paste("../02_analysis/cv/rf/", files[i], sep = ""))
  df_rf_list[[i]] <- cbind(grid, rmse_RF)
  colnames(df_rf_list[[i]]) <- c("mtry", "trees", paste("rmse_fold_",i, sep = ""))
}

# Produce a plot that shows RMSE vs. Hyperparameters
rf_df <- purrr::reduce(df_rf_list, .f = full_join) %>%
  mutate(mean = rowMeans(.[3:7])) %>%
  arrange(desc(mean))

library(plotly)
rf_plot <- plot_ly(x = rf_df$mtry, y = rf_df$trees, z = rf_df$mean,
                   type="scatter3d",
                   mode = "markers",
                   marker = list(color = rf_df$mean,
                                 colorbar = list(title = "RMSE"),
                                 colorscale = list(c(0, 1), c('25c900', 'bf0000')),
                                 showscale = TRUE,
                                 line = list(width = 0), size = 6)) %>% layout(
                                   margin = list(l = 0, r = 0, t = 0, b = 0, pad = 0),
                                   title = "",
                                   scene = list(
                                     xaxis = list(title = "Vars per Split"),
                                     yaxis = list(title = "Trees"),
                                     zaxis = list(title = "RMSE",
                                                  range=c(4200,10000),
                                                  tick0 = 4500,
                                                  dtick = 1000),
                                     annotations = list(list(
                                       showarrow = T,
                                       z = min(rf_df$mean),
                                       y = rf_df$trees[which.min(rf_df$mean)],
                                       x = rf_df$mtry[which.min(rf_df$mean)],
                                       ay = -150,
                                       ax = 150,
                                       text = "Minimum",
                                       arrowcolor = "black",
                                       arrowsize = 1,
                                       arrowwidth = 1,
                                       arrowhead = 1,
                                       font = list(
                                         size = 14
                                       ))
                                     ))) %>% config(displayModeBar = F)

f <- paste0("p.",i,".html")
htmlwidgets::saveWidget(rf_plot, f)
htmltools::tags$iframe(
    src=f,
    width="97%", 
    height="700",
    scrolling="no", 
    seamless="seamless", 
    frameBorder="0"
  )

```
</div>
---

# Analysis

### Decision Tree Methods

#### Boosting

---

class: inverse, center, middle

# Robustness

# `r fontawesome::fa("check", fill = "white")`

---

# Robustness

.content-box-grey[

Calculation of various alternative estimations, especially:

- Inclusion of variables “time_segm_price” and “artikpr”
  - Have been excluded beforehand as they are combinations of existing variables
  - Including these yields a higher RMSE -> No improvement of the model
  
- Reducing share of NAs for removing variables from the dataset
  - Beforehand: 50%
  - Reducing it until 20%
  - Gain in No. of variables and observations does not lead to higher precision

]
---

class: inverse, center, middle

# Conclusion

# `r fontawesome::fa("flag-checkered", fill = "white")`

---

class: inverse, center, middle

#Discussion

# `r fontawesome::fa("comments", fill = "white")`
